<app-breadcrumbs title="Template Approval" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

<div class="card">
  <div class="card-header">
    <h4 class="card-title mb-0 flex-grow-1">Template Approval Management</h4>
  </div>
  <div class="card-body">
    <!-- Search and Filters -->
    <div class="row">
      <!-- General Search -->
      <div class="col-md-3">
        <div class="search-box">
          <input type="text" 
                 class="form-control search" 
                 placeholder="Search template, actor, description..." 
                 [(ngModel)]="searchTerm"
                 (input)="onSearchInput($event)" 
                 [disabled]="loading" />
          <i class="ri-search-line search-icon"></i>
        </div>
      </div>
      
      <!-- Status Filter -->
      <div class="col-md-2">
        <select class="form-select" 
                [(ngModel)]="filterIsActive" 
                (change)="onFilterChange()"
                [disabled]="loading"
                title="Filter by Status">
          <option [ngValue]="undefined">All Status</option>
          <option [ngValue]="true">Active</option>
          <option [ngValue]="false">Inactive</option>
        </select>
      </div>
      
      <!-- Line Code Filter -->
      <div class="col-md-2">
        <input type="text" 
               class="form-control" 
               placeholder="Line Code" 
               [(ngModel)]="filterLineCode" 
               (input)="onLineCodeFilterChange()"
               [disabled]="loading"
               title="Filter by Line Code" />
      </div>
      
      <!-- Model Type Filter -->
      <div class="col-md-2">
        <select class="form-select" 
                [(ngModel)]="filterModelType" 
                (change)="onFilterChange()"
                [disabled]="loading"
                title="Filter by Model Type">
          <option value="">All Models</option>
          <option *ngFor="let model of modelTypes" [value]="model.value">{{ model.label }}</option>
        </select>
      </div>
      
      <!-- Action Buttons -->
      <div class="col-md-3">
        <div style="float: right">
          <button type="button" 
                  class="btn btn-outline-secondary btn-sm me-2" 
                  (click)="clearFilters()"
                  [disabled]="loading"
                  title="Clear all filters and search">
            <i class="ri-refresh-line"></i> Clear
          </button>
          <span style="margin-right: 4px">Show</span>
          <select class="data rounded-3" 
                  id="pageSizeDropdown" 
                  [(ngModel)]="pageSize" 
                  (change)="onPageSizeChange()"
                  [disabled]="loading">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span style="margin-left: 4px">Data</span>
        </div>
      </div>
      
      <!-- Add Button and Status -->
      <div class="col-12 mt-3">
        <button type="button" 
                class="btn btn-primary btn-sm" 
                (click)="onAction('add', '')"
                [disabled]="loading">
          <span class="ri-add-circle-line"></span> Add Template Approval
        </button>
        
        <span *ngIf="loading" class="ms-2">
          <i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Loading...
        </span>

        <!-- Active Filters Display -->
        <div class="mt-2" *ngIf="searchTerm || filterIsActive !== undefined || filterLineCode || filterModelType">
          <small class="text-muted">
            <strong>Active filters:</strong>
            <span *ngIf="searchTerm" class="badge bg-light text-dark me-1">
              Search: "{{ searchTerm }}" 
              <i class="ri-close-line" (click)="searchTerm = ''; onSearchInput({target: {value: ''}})" 
                 style="cursor: pointer;" title="Remove search"></i>
            </span>
            <span *ngIf="filterIsActive !== undefined" class="badge bg-light text-dark me-1">
              Status: {{ filterIsActive ? 'Active' : 'Inactive' }}
              <i class="ri-close-line" (click)="filterIsActive = undefined; onFilterChange()" 
                 style="cursor: pointer;" title="Remove status filter"></i>
            </span>
            <span *ngIf="filterLineCode" class="badge bg-light text-dark me-1">
              Line Code: "{{ filterLineCode }}"
              <i class="ri-close-line" (click)="filterLineCode = ''; onLineCodeFilterChange()" 
                 style="cursor: pointer;" title="Remove line code filter"></i>
            </span>
            <span *ngIf="filterModelType" class="badge bg-light text-dark me-1">
              Model: {{ getModelTypeLabel(filterModelType) }}
              <i class="ri-close-line" (click)="filterModelType = ''; onFilterChange()" 
                 style="cursor: pointer;" title="Remove model type filter"></i>
            </span>
          </small>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="row mt-3">
      <div class="table-responsive" [class.table-loading]="loading">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th scope="col" class="text-center" (click)="onSort('id')" style="cursor: pointer;">
                No
                <span [class]="getSortIcon('id')"></span>
              </th>
              <th scope="col" (click)="onSort('template_name')" style="cursor: pointer;">
                Template Name
                <span [class]="getSortIcon('template_name')"></span>
              </th>
              <th scope="col" class="text-center" (click)="onSort('step_order')" style="cursor: pointer;">
                Step
                <span [class]="getSortIcon('step_order')"></span>
              </th>
              <th scope="col" (click)="onSort('actor_name')" style="cursor: pointer;">
                Actor
                <span [class]="getSortIcon('actor_name')"></span>
              </th>
              <th scope="col" (click)="onSort('model_type')" style="cursor: pointer;">
                Model Type
                <span [class]="getSortIcon('model_type')"></span>
              </th>
              <th scope="col" (click)="onSort('line_code')" style="cursor: pointer;">
                Line Code
                <span [class]="getSortIcon('line_code')"></span>
              </th>
              <th scope="col" class="text-center" (click)="onSort('priority')" style="cursor: pointer;">
                Priority
                <span [class]="getSortIcon('priority')"></span>
              </th>
              <th scope="col" class="text-center">Approvals</th>
              <th scope="col" class="text-center" (click)="onSort('is_active')" style="cursor: pointer;">
                Status
                <span [class]="getSortIcon('is_active')"></span>
              </th>
              <th scope="col" class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="listData && listData.length > 0; else noData">
              <tr *ngFor="let data of listData; let i = index">
                <td class="text-center">{{ (page - 1) * pageSize + i + 1 }}</td>
                <td>
                  <strong>{{ data?.template_name }}</strong>
                  <br>
                  <small class="text-muted">{{ data?.description || '-' }}</small>
                </td>
                <td class="text-center">
                  <span class="badge bg-primary">{{ data?.step_order }}</span>
                </td>
                <td>{{ data?.actor_name || '-' }}</td>
                <td>
                  <span class="badge bg-info">{{ getModelTypeLabel(data?.model_type) }}</span>
                </td>
                <td>
                  <span *ngIf="data?.line_code; else noLineCode" 
                        class="badge bg-secondary">{{ data.line_code }}</span>
                  <ng-template #noLineCode>-</ng-template>
                </td>
                <td class="text-center">{{ data?.priority || 0 }}</td>
                <td class="text-center">
                  <div class="d-flex justify-content-center gap-1">
                    <span *ngIf="data?.need_engineering_approval" class="badge bg-warning" title="Engineering">ENG</span>
                    <span *ngIf="data?.need_production_approval" class="badge bg-success" title="Production">PROD</span>
                    <span *ngIf="!data?.need_engineering_approval && !data?.need_production_approval" class="text-muted">-</span>
                  </div>
                </td>
                <td class="text-center status-cell">
                  <span *ngIf="data.is_active" class="status-badge active">Active</span>
                  <span *ngIf="!data.is_active" class="status-badge inactive">Inactive</span>
                </td>
                <td class="text-center">
                  <div class="hstack gap-2 justify-content-center">
                    <button class="btn btn-primary btn-icon waves-effect waves-light" 
                            ngbTooltip="Edit template approval"
                            (click)="onAction('edit', data)"
                            [disabled]="loading">
                        <span class="ri-edit-fill"></span>
                    </button>
                    <button class="btn btn-warning btn-icon waves-effect waves-light" 
                            ngbTooltip="Toggle status"
                            (click)="onToggleStatus(data.id)"
                            [disabled]="loading">
                        <span class="ri-toggle-line"></span>
                    </button>
                    <button class="btn btn-danger btn-icon waves-effect waves-light" 
                            ngbTooltip="Delete template approval"
                            (click)="onDelete(data.id)"
                            [disabled]="loading">
                        <span class="ri-delete-bin-5-line"></span>
                    </button>
                  </div>
                </td>
              </tr>
            </ng-container>
            <ng-template #noData>
              <tr>
                <td colspan="10" class="text-center">
                  <div class="py-4">
                    <i class="ri-search-line fs-1 text-muted"></i>
                    <p class="text-muted mt-2 mb-0">
                      <span *ngIf="searchTerm || filterIsActive !== undefined || filterLineCode || filterModelType; else noFilters">
                        No results found with current filters.
                        <br>
                        <small>
                          Try adjusting your search criteria or 
                          <button type="button" class="btn btn-link btn-sm p-0" (click)="clearFilters()">clear all filters</button>
                        </small>
                      </span>
                      <ng-template #noFilters>No template approval data available.</ng-template>
                    </p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="row justify-content-md-between align-items-md-center">
        <div class="col col-sm-6">
          <div class="dataTables_info mb-2" id="tickets-table_info" role="status" aria-live="polite">
            {{ getShowingText() }} 
          </div>
        </div>
        <div class="col col-sm-6">
          <div class="pagination justify-content-end">
            <ngb-pagination [collectionSize]="totalRecords" 
                           [(page)]="page" 
                           [pageSize]="pageSize" 
                           [maxSize]="maxSize"
                           [rotate]="true" 
                           [boundaryLinks]="true" 
                           [disabled]="loading"
                           (pageChange)="onPageChange($event)"></ngb-pagination>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Form -->
<ng-template #modalForm let-modal>
  <div class="modal-header">
    <h5 class="modal-title">{{ statusForm | titlecase }} Template Approval</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>

  <div class="modal-body">
    <form [formGroup]="formData" (ngSubmit)="onSubmit()">
      <div class="row">
        <!-- Template Name -->
        <div class="col-md-6 mb-3">
          <label for="template_name" class="form-label">Template Name <span class="text-danger">*</span></label>
          <input type="text" 
                 class="form-control" 
                 id="template_name" 
                 formControlName="template_name"
                 placeholder="Enter Template Name"
                 [class.is-invalid]="form.template_name.touched && form.template_name.invalid">
          <div *ngIf="form.template_name.touched && form.template_name.invalid" class="invalid-feedback">
            <div *ngIf="form.template_name.errors?.['required']">Template Name is required.</div>
            <div *ngIf="form.template_name.errors?.['minlength']">Template Name must be at least 3 characters.</div>
            <div *ngIf="form.template_name.errors?.['maxlength']">Template Name cannot exceed 255 characters.</div>
          </div>
        </div>

        <!-- Step Order -->
        <div class="col-md-6 mb-3">
          <label for="step_order" class="form-label">Step Order <span class="text-danger">*</span></label>
          <input type="number" 
                 class="form-control" 
                 id="step_order" 
                 formControlName="step_order" 
                 min="0"
                 placeholder="Enter Step Order"
                 [class.is-invalid]="form.step_order.touched && form.step_order.invalid">
          <div *ngIf="form.step_order.touched && form.step_order.invalid" class="invalid-feedback">
            <div *ngIf="form.step_order.errors?.['required']">Step Order is required.</div>
            <div *ngIf="form.step_order.errors?.['min']">Step Order must be 0 or greater.</div>
          </div>
        </div>

        <!-- Actor Name -->
        <div class="col-md-6 mb-3">
          <label for="actor_name" class="form-label">Actor Name <span class="text-danger">*</span></label>
          <input type="text" 
                 class="form-control" 
                 id="actor_name" 
                 formControlName="actor_name"
                 placeholder="Enter Actor Name"
                 [class.is-invalid]="form.actor_name.touched && form.actor_name.invalid">
          <div *ngIf="form.actor_name.touched && form.actor_name.invalid" class="invalid-feedback">
            <div *ngIf="form.actor_name.errors?.['required']">Actor Name is required.</div>
            <div *ngIf="form.actor_name.errors?.['maxlength']">Actor Name cannot exceed 255 characters.</div>
          </div>
        </div>

        <!-- Model Type -->
        <div class="col-md-6 mb-3">
          <label for="model_type" class="form-label">Model Type <span class="text-danger">*</span></label>
          <select class="form-select" 
                  id="model_type" 
                  formControlName="model_type"
                  [class.is-invalid]="form.model_type.touched && form.model_type.invalid">
            <option value="">Select Model Type</option>
            <option *ngFor="let model of modelTypes" [value]="model.value">{{ model.label }}</option>
          </select>
          <div *ngIf="form.model_type.touched && form.model_type.invalid" class="invalid-feedback">
            <div *ngIf="form.model_type.errors?.['required']">Model Type is required.</div>
          </div>
        </div>

        <!-- Line Code -->
        <div class="col-md-6 mb-3">
          <label for="line_code" class="form-label">Line Code</label>
          <input type="text" 
                 class="form-control" 
                 id="line_code" 
                 formControlName="line_code"
                 placeholder="Enter Line Code"
                 [class.is-invalid]="form.line_code.touched && form.line_code.invalid">
          <div *ngIf="form.line_code.touched && form.line_code.invalid" class="invalid-feedback">
            <div *ngIf="form.line_code.errors?.['maxlength']">Line Code cannot exceed 50 characters.</div>
          </div>
        </div>

        <!-- Priority -->
        <div class="col-md-6 mb-3">
          <label for="priority" class="form-label">Priority</label>
          <input type="number" 
                 class="form-control" 
                 id="priority" 
                 formControlName="priority" 
                 min="0"
                 placeholder="Enter Priority"
                 [class.is-invalid]="form.priority.touched && form.priority.invalid">
          <div *ngIf="form.priority.touched && form.priority.invalid" class="invalid-feedback">
            <div *ngIf="form.priority.errors?.['min']">Priority must be 0 or greater.</div>
          </div>
        </div>

        <!-- Section ID -->
        <div class="col-md-6 mb-3">
          <label for="section_id" class="form-label">Section ID</label>
          <input type="number" 
                 class="form-control" 
                 id="section_id" 
                 formControlName="section_id"
                 placeholder="Enter Section ID">
        </div>

        <!-- Description -->
        <div class="col-12 mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" 
                    id="description" 
                    formControlName="description" 
                    rows="3"
                    placeholder="Enter Description"
                    [class.is-invalid]="form.description.touched && form.description.invalid"></textarea>
          <div *ngIf="form.description.touched && form.description.invalid" class="invalid-feedback">
            <div *ngIf="form.description.errors?.['maxlength']">Description cannot exceed 500 characters.</div>
          </div>
        </div>

        <!-- Checkboxes -->
        <div class="col-12 mb-3">
          <div class="row">
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="need_engineering_approval" 
                       formControlName="need_engineering_approval">
                <label class="form-check-label" for="need_engineering_approval">
                  Engineering Approval
                </label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="need_production_approval" 
                       formControlName="need_production_approval">
                <label class="form-check-label" for="need_production_approval">
                  Production Approval
                </label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="use_dynamic_section" 
                       formControlName="use_dynamic_section">
                <label class="form-check-label" for="use_dynamic_section">
                  Dynamic Section
                </label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="use_line_section" 
                       formControlName="use_line_section">
                <label class="form-check-label" for="use_line_section">
                  Line Section
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Status -->
        <div class="col-12 mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="is_active" 
                   formControlName="is_active" 
                   role="switch">
            <label class="form-check-label" for="is_active">
              {{ formData.get('is_active')?.value ? 'Active' : 'Inactive' }}
            </label>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('close')">Close</button>
    <button type="submit" 
            class="btn btn-primary" 
            [disabled]="formData.invalid || loading" 
            (click)="onSubmit()">
      <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
      {{ statusForm === 'add' ? 'Submit' : 'Update' }}
    </button>
  </div>
</ng-template>