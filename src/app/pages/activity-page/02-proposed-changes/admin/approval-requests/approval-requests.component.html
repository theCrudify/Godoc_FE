<!-- src/app/pages/activity-page/02-proposed-changes/admin/approval-requests/approval-requests.component.html -->

<app-breadcrumbs title="Approval Requests" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

<div class="card" @fadeIn>
  <div class="card-header">
    <h4 class="card-title mb-0 flex-grow-1">Approver Change Requests Management</h4>
  </div>
  
  <div class="card-body">
    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-xxl-3 col-md-6">
        <div class="card card-height-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-warning-subtle text-warning rounded-circle fs-3">
                  <i class="ri-time-line"></i>
                </span>
              </div>
              <div class="flex-grow-1 ms-3">
                <p class="text-uppercase fw-semibold fs-12 text-muted mb-1">Pending</p>
                <h4 class="mb-0">{{ stats.pending }}</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xxl-3 col-md-6">
        <div class="card card-height-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-success-subtle text-success rounded-circle fs-3">
                  <i class="ri-check-line"></i>
                </span>
              </div>
              <div class="flex-grow-1 ms-3">
                <p class="text-uppercase fw-semibold fs-12 text-muted mb-1">Approved</p>
                <h4 class="mb-0">{{ stats.approved }}</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xxl-3 col-md-6">
        <div class="card card-height-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-danger-subtle text-danger rounded-circle fs-3">
                  <i class="ri-close-line"></i>
                </span>
              </div>
              <div class="flex-grow-1 ms-3">
                <p class="text-uppercase fw-semibold fs-12 text-muted mb-1">Rejected</p>
                <h4 class="mb-0">{{ stats.rejected }}</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xxl-3 col-md-6">
        <div class="card card-height-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="avatar-sm flex-shrink-0">
                <span class="avatar-title bg-info-subtle text-info rounded-circle fs-3">
                  <i class="ri-alarm-warning-line"></i>
                </span>
              </div>
              <div class="flex-grow-1 ms-3">
                <p class="text-uppercase fw-semibold fs-12 text-muted mb-1">Urgent</p>
                <h4 class="mb-0">{{ stats.urgent }}</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="row align-items-center mb-3">
      <div class="col-md-4 mb-3 mb-md-0">
        <div class="search-box position-relative">
          <input type="text" class="form-control search" placeholder="Search project, reason, approver..." 
                 [(ngModel)]="searchTerm" (input)="onSearch()" [disabled]="loading" />
          <i class="ri-search-line search-icon"></i>
        </div>
      </div>
      
      <div class="col-md-3 mb-3 mb-md-0">
        <select class="form-select" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" [disabled]="loading">
          <option value="">All Status</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      
      <div class="col-md-3 mb-3 mb-md-0">
        <select class="form-select" [(ngModel)]="priorityFilter" (change)="onPriorityFilterChange()" [disabled]="loading">
          <option value="">All Priority</option>
          <option value="urgent">Urgent</option>
          <option value="high">High</option>
          <option value="normal">Normal</option>
          <option value="low">Low</option>
        </select>
      </div>
      
      <div class="col-md-2">
        <div class="d-flex justify-content-end align-items-center">
          <span class="me-2">Show</span>
          <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" 
                  (change)="onPageSizeChange()" [disabled]="loading">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary" (click)="goBack()">
            <i class="ri-arrow-left-line me-1"></i> Back to List
          </button>
          <button type="button" class="btn btn-outline-success" (click)="refreshData()">
            <i class="ri-refresh-line me-1"></i> Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="loading" class="col-12 text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-responsive" *ngIf="!loading">
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th scope="col" class="text-center">No</th>
            <th scope="col">Project Info</th>
            <th scope="col">Approver Change</th>
            <th scope="col">Request Details</th>
            <th scope="col" class="text-center">Status</th>
            <th scope="col" class="text-center">Actions</th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngIf="requestList && requestList.length > 0; else noData">
            <tr *ngFor="let request of requestList; let i = index" @listAnimation>
              <td class="text-center">{{ (page - 1) * pageSize + i + 1 }}</td>
              
              <!-- Project Info -->
              <td>
                <div class="d-flex flex-column">
                  <h6 class="mb-1 text-primary fw-semibold">
                    {{ request.tr_proposed_changes?.project_name || '-' }}
                  </h6>
                  <small class="text-muted">
                    <i class="ri-building-line me-1"></i>
                    {{ request.tr_proposed_changes?.department?.department_name || '-' }}
                  </small>
                  <small class="text-muted">
                    <i class="ri-calendar-line me-1"></i>
                    {{ formatDate(request.created_date) }}
                  </small>
                  
                  <!-- Priority Badge -->
                  <span class="badge mt-1 align-self-start" [ngClass]="getPriorityBadgeClass(request.priority)">
                    <i class="ri-flag-line me-1" *ngIf="request.urgent"></i>
                    {{ request.priority | titlecase }}
                    <span *ngIf="request.urgent"> - URGENT</span>
                  </span>
                </div>
              </td>
              
              <!-- Approver Change -->
              <td>
                <div class="d-flex flex-column">
                  <div class="mb-2">
                    <small class="text-muted">From:</small>
                    <div class="fw-semibold">
                      {{ request.mst_authorization_tr_approver_change_request_current_auth_idTomst_authorization?.employee_name || '-' }}
                    </div>
                    <small class="text-muted">
                      ({{ request.mst_authorization_tr_approver_change_request_current_auth_idTomst_authorization?.employee_code || '-' }})
                    </small>
                  </div>
                  
                  <div class="text-center mb-2">
                    <i class="ri-arrow-down-line text-primary fs-5"></i>
                  </div>
                  
                  <div>
                    <small class="text-muted">To:</small>
                    <div class="fw-semibold text-success">
                      {{ request.mst_authorization_tr_approver_change_request_new_auth_idTomst_authorization?.employee_name || '-' }}
                    </div>
                    <small class="text-muted">
                      ({{ request.mst_authorization_tr_approver_change_request_new_auth_idTomst_authorization?.employee_code || '-' }})
                    </small>
                  </div>
                  
                  <div class="mt-2">
                    <small class="text-muted">Step:</small>
                    <span class="badge bg-info ms-1">
                      Step {{ request.tr_proposed_changes_approval_tr_approver_change_request_approval_idTotr_proposed_changes_approval?.step }} 
                      ({{ request.tr_proposed_changes_approval_tr_approver_change_request_approval_idTotr_proposed_changes_approval?.actor }})
                    </span>
                  </div>
                </div>
              </td>
              
              <!-- Request Details -->
              <td>
                <div class="d-flex flex-column">
                  <div class="mb-2">
                    <small class="text-muted">Requested by:</small>
                    <div class="fw-semibold">
                      {{ request.mst_authorization_tr_approver_change_request_requester_auth_idTomst_authorization?.employee_name || '-' }}
                    </div>
                  </div>
                  
                  <div>
                    <small class="text-muted">Reason:</small>
                    <div class="text-wrap" style="max-width: 300px;">
                      {{ request.reason }}
                    </div>
                  </div>
                  
                  <div class="mt-2" *ngIf="request.admin_decision">
                    <small class="text-muted">Admin Decision:</small>
                    <div class="text-wrap text-info" style="max-width: 300px;">
                      {{ request.admin_decision }}
                    </div>
                    <small class="text-muted">
                      by {{ request.processed_by }} - {{ formatDate(request.processed_date) }}
                    </small>
                  </div>
                </div>
              </td>
              
              <!-- Status -->
              <td class="text-center">
                <span class="badge px-3 py-2 fw-bold fs-6" [ngClass]="getStatusBadgeClass(request.status)">
                  {{ request.status | titlecase }}
                </span>
              </td>
              
              <!-- Actions -->
              <td class="text-center">
                <div class="hstack gap-2 justify-content-center">
                  <!-- View Proposed Changes -->
                  <button class="btn btn-outline-primary btn-sm waves-effect waves-light" 
                          ngbTooltip="View Proposed Changes" 
                          (click)="viewProposedChangesDetail(request.proposed_changes_id)">
                    <i class="ri-eye-line"></i>
                  </button>
                  
                  <!-- Approve Button -->
                  <button class="btn btn-success btn-sm waves-effect waves-light" 
                          ngbTooltip="Approve Request"
                          [disabled]="request.status !== 'pending' || processingRequestId === request.id"
                          (click)="processRequest(request.id, 'approved')"
                          *ngIf="request.status === 'pending'">
                    <span *ngIf="processingRequestId === request.id" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="ri-check-line" *ngIf="processingRequestId !== request.id"></i>
                  </button>
                  
                  <!-- Reject Button -->
                  <button class="btn btn-danger btn-sm waves-effect waves-light" 
                          ngbTooltip="Reject Request"
                          [disabled]="request.status !== 'pending' || processingRequestId === request.id"
                          (click)="processRequest(request.id, 'rejected')"
                          *ngIf="request.status === 'pending'">
                    <span *ngIf="processingRequestId === request.id" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="ri-close-line" *ngIf="processingRequestId !== request.id"></i>
                  </button>
                  
                  <!-- Already Processed Badge -->
                  <span class="badge bg-light text-muted" *ngIf="request.status !== 'pending'">
                    Already {{ request.status }}
                  </span>
                </div>
              </td>
            </tr>
          </ng-container>
          
          <ng-template #noData>
            <tr>
              <td colspan="6" class="text-center py-4">
                <div class="d-flex flex-column align-items-center">
                  <i class="ri-file-search-line fs-3 mb-2"></i>
                  <p class="mb-0">No approval requests found.</p>
                  <small class="text-muted">Try adjusting your filters or search terms.</small>
                </div>
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>

    <!-- Pagination Section -->
    <div class="row justify-content-between align-items-center mt-3" *ngIf="!loading && totalRecords > 0">
      <div class="col-12 col-sm-6">
        <div class="dataTables_info mb-2" id="approval-requests-table_info" role="status" aria-live="polite">
          {{ getShowingText() }}
        </div>
      </div>

      <div class="col-12 col-sm-6">
        <div class="pagination justify-content-sm-end">
          <ngb-pagination [collectionSize]="totalRecords" [(page)]="page" [pageSize]="pageSize"
                          [maxSize]="maxSize" [rotate]="true" [boundaryLinks]="true"
                          (pageChange)="onPageChange($event)" aria-label="Pagination"></ngb-pagination>
        </div>
      </div>
    </div>
  </div>
</div>