<app-breadcrumbs title="Proposed Changes Form" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

<div class="card">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h3 class="card-title mb-0">Proposed Changes Form</h3>
      <button type="button" class="btn btn-secondary btn-lg" (click)="goBack()">
        <i class="ri-arrow-left-line align-middle me-1"></i> Back to List
      </button>
    </div>
  </div>

  <!-- Form Progress Indicator -->
  <div class="card-body bg-light border-bottom mb-0 pb-0">
    <div class="form-progress-container">
      <div class="row">
        <div class="col-12">
          <div class="progress-tracker">
            <div class="progress" style="height: 15px;">
              <div class="progress-bar" role="progressbar" [style.width]="getFormProgress() + '%'" aria-valuenow="0"
                aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span class="badge rounded-pill text-bg-primary fs-5 px-3 py-2">{{ getFormProgress() }}% Complete</span>
              <span *ngIf="isMandatoryFieldsComplete()" class="badge rounded-pill text-bg-success fs-5 px-3 py-2">
                <i class="ri-check-line me-1"></i>All required fields completed
              </span>
              <span *ngIf="!isMandatoryFieldsComplete()" class="badge rounded-pill text-bg-warning fs-5 px-3 py-2">
                <i class="ri-error-warning-line me-1"></i>Required fields incomplete
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Instructions -->
    <div class="form-instructions mt-3" *ngIf="showInstructions">
      <div class="alert alert-info">
        <div class="d-flex">
          <div class="me-3">
            <i class="ri-information-line fs-1"></i>
          </div>
          <div>
            <h4 class="alert-heading">Instruksi Pengisian Form</h4>
            <p class="fs-5">Untuk menyelesaikan form ini dengan benar, silakan ikuti panduan berikut:</p>
            <ol class="mb-0 fs-5">
              <li>Mulai dengan memilih <strong>Document Number</strong> yang sesuai</li>
              <li>Isi semua field yang ditandai dengan <span class="text-danger">*</span> (wajib)</li>
              <li>Pastikan tanggal planning tidak saling bertabrakan</li>
              <li>Centang dokumen pendukung yang diperlukan di bagian bawah</li>
              <li>Klik tombol Submit setelah semua field terisi dengan benar</li>
            </ol>
          </div>
        </div>
        <button type="button" class="btn-close float-end" (click)="hideInstructions()"></button>
      </div>
    </div>
    <div *ngIf="!showInstructions" class="text-end mb-2">
      <button class="btn btn-outline-info btn-lg" (click)="toggleInstructions()">
        <i class="ri-information-line me-1"></i> Tampilkan Instruksi
      </button>
    </div>
  </div>

  <div class="card-body">
    <form [formGroup]="formData" (ngSubmit)="onSubmit()">
      <!-- Document Number Selection (First) -->
      <div class="col-md-6">
        <div class="mb-3">
          <!-- Label -->
          <label class="form-label fs-3 fw-bold">
            Document Number <span class="text-danger">*</span>
          </label>

          <!-- Form + Icon -->
          <div class="d-flex align-items-stretch py-2">
            <!-- ng-select with flex-grow -->
            <div class="flex-grow-1 me-2">
              <ng-select formControlName="document_number_id" [items]="documentNumbers" bindLabel="display"
                bindValue="id" placeholder="Type or select Document Number" [typeahead]="searchInput$"
                [loading]="loading" class="form-control-lg fs-4 h-100 w-100" [ngClass]="{
                'ng-invalid': formData.get('document_number_id')?.invalid && formData.get('document_number_id')?.touched
              }">
                <ng-template ng-option-tmp let-item="item">
                  {{ item.display }}
                </ng-template>
                <ng-template ng-notfound-tmp>
                  <div class="p-2 text-center">
                    No documents found
                  </div>
                </ng-template>
              </ng-select>

            </div>

            <!-- Status Icon -->
            <div class="d-flex align-items-center">
              <i *ngIf="formData.get('document_number_id')?.valid && formData.get('document_number_id')?.value"
                class="ri-checkbox-circle-fill text-success fs-4" title="Document number selected"></i>
              <i *ngIf="formData.get('document_number_id')?.invalid && formData.get('document_number_id')?.touched"
                class="ri-error-warning-fill text-danger fs-4" title="Document number required"></i>
              <i *ngIf="!formData.get('document_number_id')?.touched || !formData.get('document_number_id')?.value"
                class="ri-checkbox-blank-circle-line text-secondary fs-4" title="Select a document number"></i>
            </div>
          </div>

          <!-- Error message -->
          <div class="mt-2 text-danger fs-5"
            *ngIf="formData.get('document_number_id')?.invalid && formData.get('document_number_id')?.touched">
            Document Number is required
          </div>

          <!-- Help text -->
          <small class="form-text text-muted fs-4 mt-3 d-block">
            Type to search or select a document number
          </small>
        </div>
      </div>


      <div class="row">
        <!-- First Column -->
        <div class="col-md-6">
          <!-- Project Name -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Project Name <span class="text-danger">*</span></label>
            <div class="input-group input-group-lg">
              <input type="text" class="form-control form-control-lg" formControlName="project_name"
                [ngClass]="{'is-invalid': formData.get('project_name')?.invalid && formData.get('project_name')?.touched}">
              <span class="input-group-text bg-light">
                <i *ngIf="formData.get('project_name')?.valid && formData.get('project_name')?.value"
                  class="ri-checkbox-circle-fill text-success fs-3"></i>
                <i *ngIf="formData.get('project_name')?.invalid && formData.get('project_name')?.touched"
                  class="ri-error-warning-fill text-danger fs-3"></i>
                <i *ngIf="!formData.get('project_name')?.touched || !formData.get('project_name')?.value"
                  class="ri-checkbox-blank-circle-line text-secondary fs-3"></i>
              </span>
            </div>
            <div class="invalid-feedback fs-5"
              *ngIf="formData.get('project_name')?.invalid && formData.get('project_name')?.touched">
              Project Name is required
            </div>
          </div>

          <!-- Item Changes -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Item Changes <span class="text-danger">*</span></label>
            <div class="input-group input-group-lg">
              <select class="form-select form-select-lg" formControlName="item_changes"
                [ngClass]="{'is-invalid': formData.get('item_changes')?.invalid && formData.get('item_changes')?.touched}">
                <option value="" disabled selected>Select Item Changes</option>
                <option *ngFor="let type of changeTypes" [value]="type.display">
                  {{ type.display }}
                </option>
              </select>
              <span class="input-group-text bg-light">
                <i *ngIf="formData.get('item_changes')?.valid && formData.get('item_changes')?.value"
                  class="ri-checkbox-circle-fill text-success fs-3"></i>
                <i *ngIf="formData.get('item_changes')?.invalid && formData.get('item_changes')?.touched"
                  class="ri-error-warning-fill text-danger fs-3"></i>
                <i *ngIf="!formData.get('item_changes')?.touched || !formData.get('item_changes')?.value"
                  class="ri-checkbox-blank-circle-line text-secondary fs-3"></i>
              </span>
            </div>
            <div class="invalid-feedback fs-5"
              *ngIf="formData.get('item_changes')?.invalid && formData.get('item_changes')?.touched">
              Item Changes is required
            </div>
          </div>

          <!-- Line Code -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Line Code</label>
            <input type="text" class="form-control form-control-lg" formControlName="line_code"
              [ngClass]="{'readonly-field': true}" readonly>
            <small class="text-muted fs-5">Auto-filled from document number</small>
          </div>

          <!-- Section Code -->
          <!-- Section Code dengan informasi tambahan -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Section Code</label>
            <input type="text" class="form-control form-control-lg" formControlName="section_code"
              [ngClass]="{'readonly-field': true}" readonly>
            <small class="text-muted fs-5">Auto-filled from document number (Section Code - Area)</small>
          </div>

          <!-- Area Information - Optional additional field if you want to show area separately -->
          <div class="mb-3" *ngIf="selectedDoc && selectedDoc.fullData && selectedDoc.fullData.area">
            <label class="form-label fs-4 fw-bold">Area</label>
            <input type="text" class="form-control form-control-lg" [value]="selectedDoc.fullData.area.area || ''"
              readonly>
            <small class="text-muted fs-5">Area from selected document</small>
          </div>

          <!-- Department -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Department</label>
            <input type="text" class="form-control form-control-lg" [value]="GodocUser?.department?.department_name"
              readonly>
          </div>

          <!-- Section -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Section</label>
            <input type="text" class="form-control form-control-lg" [value]="GodocUser?.section?.section_name" readonly>
          </div>

          <!-- Plant -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Plant</label>
            <input type="text" class="form-control form-control-lg" [value]="GodocUser?.site?.plant_name" readonly>
          </div>
        </div>

        <!-- Second Column -->
        <div class="col-md-6">
          <!-- Change Type -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Change Type <span class="text-danger">*</span></label>
            <div class="input-group input-group-lg">
              <select class="form-select form-select-lg" formControlName="change_type"
                [ngClass]="{'is-invalid': formData.get('change_type')?.invalid && formData.get('change_type')?.touched}">
                <option value="" disabled selected>Select Change Type</option>
                <option value="Improvement">Improvement</option>
                <option value="Modification">Modification</option>
                <option value="New Installation">New Installation</option>
                <option value="Replacement">Replacement</option>
              </select>
              <span class="input-group-text bg-light">
                <i *ngIf="formData.get('change_type')?.valid && formData.get('change_type')?.value"
                  class="ri-checkbox-circle-fill text-success fs-3"></i>
                <i *ngIf="formData.get('change_type')?.invalid && formData.get('change_type')?.touched"
                  class="ri-error-warning-fill text-danger fs-3"></i>
                <i *ngIf="!formData.get('change_type')?.touched || !formData.get('change_type')?.value"
                  class="ri-checkbox-blank-circle-line text-secondary fs-3"></i>
              </span>
            </div>
            <div class="invalid-feedback fs-5"
              *ngIf="formData.get('change_type')?.invalid && formData.get('change_type')?.touched">
              Change Type is required
            </div>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Description <span class="text-danger">*</span></label>
            <div class="input-group input-group-lg">
              <textarea class="form-control" formControlName="description" rows="3"
                [ngClass]="{'is-invalid': formData.get('description')?.invalid && formData.get('description')?.touched}"></textarea>
              <span class="input-group-text bg-light">
                <i *ngIf="formData.get('description')?.valid && formData.get('description')?.value"
                  class="ri-checkbox-circle-fill text-success fs-3"></i>
                <i *ngIf="formData.get('description')?.invalid && formData.get('description')?.touched"
                  class="ri-error-warning-fill text-danger fs-3"></i>
                <i *ngIf="!formData.get('description')?.touched || !formData.get('description')?.value"
                  class="ri-checkbox-blank-circle-line text-secondary fs-3"></i>
              </span>
            </div>
            <div class="invalid-feedback fs-5"
              *ngIf="formData.get('description')?.invalid && formData.get('description')?.touched">
              Description is required
            </div>
            <small class="form-text text-muted fs-5">Jelaskan perubahan yang diusulkan secara detail</small>
          </div>

          <!-- Reason -->
          <div class="mb-3">
            <label class="form-label fs-4 fw-bold">Reason <span class="text-danger">*</span></label>
            <div class="input-group input-group-lg">
              <textarea class="form-control" formControlName="reason" rows="3"
                [ngClass]="{'is-invalid': formData.get('reason')?.invalid && formData.get('reason')?.touched}"></textarea>
              <span class="input-group-text bg-light">
                <i *ngIf="formData.get('reason')?.valid && formData.get('reason')?.value"
                  class="ri-checkbox-circle-fill text-success fs-3"></i>
                <i *ngIf="formData.get('reason')?.invalid && formData.get('reason')?.touched"
                  class="ri-error-warning-fill text-danger fs-3"></i>
                <i *ngIf="!formData.get('reason')?.touched || !formData.get('reason')?.value"
                  class="ri-checkbox-blank-circle-line text-secondary fs-3"></i>
              </span>
            </div>
            <div class="invalid-feedback fs-5"
              *ngIf="formData.get('reason')?.invalid && formData.get('reason')?.touched">
              Reason is required
            </div>
            <small class="form-text text-muted fs-5">Jelaskan alasan mengapa perubahan ini diperlukan</small>
          </div>

          <!-- Multi-Currency Cost Input -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fs-4">Cost Details</h5>
                <span class="badge rounded-pill fs-5 px-3 py-2"
                  [ngClass]="costItemsValid() ? 'text-bg-success' : 'text-bg-warning'">
                  <i [ngClass]="costItemsValid() ? 'ri-checkbox-circle-line' : 'ri-error-warning-line'"
                    class="me-1"></i>
                  {{ costItemsValid() ? 'Complete' : 'Incomplete' }}
                </span>
              </div>
            </div>
            <div class="card-body">
              <div formArrayName="costItems">
                <div *ngFor="let item of costItems.controls; let i = index" [formGroupName]="i" class="mb-3">
                  <div class="row">
                    <!-- Currency Selection -->
                    <div class="col-md-3">
                      <label class="form-label fs-5 fw-bold">Currency <span class="text-danger">*</span></label>
                      <select class="form-select form-select-lg" formControlName="currency"
                        (change)="onCurrencyChange(i, $event)"
                        [ngClass]="{'is-invalid': item.get('currency')?.invalid && item.get('currency')?.touched}">
                        <option *ngFor="let currency of currencies" [value]="currency.code">
                          {{ currency.code }} - {{ currency.name }}
                        </option>
                      </select>
                      <div class="invalid-feedback fs-5"
                        *ngIf="item.get('currency')?.invalid && item.get('currency')?.touched">
                        Currency is required
                      </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="col-md-6">
                      <label class="form-label fs-5 fw-bold">Amount <span class="text-danger">*</span></label>
                      <div class="input-group input-group-lg">
                        <span class="input-group-text">{{ getCurrencySymbol(item.get('currency')?.value) }}</span>
                        <input type="text" class="form-control form-control-lg" formControlName="amount"
                          (input)="onAmountInput(i, $event)"
                          [ngClass]="{'is-invalid': item.get('amount')?.invalid && item.get('amount')?.touched}">
                        <span class="input-group-text bg-light">
                          <i *ngIf="item.get('amount')?.valid && item.get('amount')?.value"
                            class="ri-checkbox-circle-fill text-success fs-3"></i>
                          <i *ngIf="item.get('amount')?.invalid && item.get('amount')?.touched"
                            class="ri-error-warning-fill text-danger fs-3"></i>
                          <i *ngIf="!item.get('amount')?.touched || !item.get('amount')?.value"
                            class="ri-checkbox-blank-circle-line text-secondary fs-3"></i>
                        </span>
                      </div>
                      <div class="invalid-feedback fs-5"
                        *ngIf="item.get('amount')?.invalid && item.get('amount')?.touched">
                        <span *ngIf="item.get('amount')?.errors?.['required']">Amount is required</span>
                        <span *ngIf="item.get('amount')?.errors?.['pattern']">Amount must be a number</span>
                      </div>
                    </div>

                    <!-- Add/Remove Button -->
                    <div class="col-md-3">
                      <label class="form-label d-block">&nbsp;</label>
                      <button type="button" class="btn btn-danger btn-lg" *ngIf="costItems.length > 1"
                        (click)="removeCostItem(i)">
                        <i class="ri-delete-bin-line"></i> Remove
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Add Currency Button -->
                <div class="row mt-2">
                  <div class="col-md-12">
                    <button type="button" class="btn btn-outline-primary btn-lg" (click)="addCostItem()">
                      <i class="ri-add-line"></i> Add Another Currency
                    </button>
                  </div>
                </div>

                <!-- Summary of Costs (paragraph style) -->
                <div class="row mt-4">
                  <div class="col-md-12">
                    <div class="card">
                      <div class="card-header bg-light">
                        <h6 class="mb-0 fs-4">Cost Summary</h6>
                      </div>
                      <div class="card-body">
                        <div class="cost-summary" *ngIf="costItems.length > 0">
                          <div class="mb-2" *ngFor="let item of costItems.controls; let i = index">
                            <p class="mb-1 fw-bold fs-5" *ngIf="item.get('amount')?.value">
                              {{ getCurrencySymbol(item.get('currency')?.value) }} {{
                              formatCurrency(item.get('amount')?.value) }}
                            </p>
                          </div>
                          <hr *ngIf="totalCostIDR > 0">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Planning Dates -->
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label fw-bold fs-5">Planning Period <span class="text-danger">*</span></label>
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label fs-5">Start Date <span class="text-danger">*</span></label>
                      <input type="date" class="form-control form-control-lg" formControlName="planning_start">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fs-5">End Date <span class="text-danger">*</span></label>
                      <input type="date" class="form-control form-control-lg" formControlName="planning_end">
                    </div>
                  </div>
                  <div *ngIf="!dateRangeValid()" class="alert alert-danger mt-2">
                    <i class="ri-error-warning-line me-1"></i>
                    Tanggal mulai harus sebelum atau sama dengan tanggal akhir
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Approval Requirements -->
      <div class="row mt-3">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-light">
              <h5 class="mb-0 fs-4">Approval Requirements</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check form-check-lg mb-3">
                    <input class="form-check-input" type="checkbox" id="needEngineering"
                      formControlName="need_engineering_approval">
                    <label class="form-check-label fs-5 ms-2" for="needEngineering">
                      Need Engineering Support
                    </label>
                    <i class="ri-question-line ms-1 text-primary fs-5"
                      title="Centang jika membutuhkan dukungan dari tim engineering untuk implementasi perubahan"></i>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check form-check-lg mb-3">
                    <input class="form-check-input" type="checkbox" id="needProduction"
                      formControlName="need_production_approval">
                    <label class="form-check-label fs-5 ms-2" for="needProduction">
                      Need Production Support
                    </label>
                    <i class="ri-question-line ms-1 text-primary fs-5"
                      title="Centang jika membutuhkan dukungan dari tim produksi untuk implementasi perubahan"></i>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label fs-5 fw-bold">Other Systems (if any)</label>
                <input type="text" class="form-control form-control-lg" formControlName="other_sytem">
                <small class="form-text text-muted fs-5">Masukkan sistem lain yang terlibat dalam perubahan ini
                  (opsional)</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Checklist Persiapan Perubahan -->
      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fs-4">Checklist Persiapan Perubahan</h5>
                <span class="badge rounded-pill fs-5 px-3 py-2"
                  [ngClass]="hasSelectedDocuments() ? 'text-bg-success' : 'text-bg-secondary'">
                  {{ getSelectedDocumentsCount() }} dokumen terpilih
                </span>
              </div>
            </div>
            <div class="card-body">
              <!-- Menggunakan formData2 -->
              <div [formGroup]="formData2">
                <div class="col-lg-12">
                  <div class="box-wrapper">
                    <div class="mb-3">
                      <div class="input-group input-group-lg">
                        <input type="text" class="form-control form-control-lg" placeholder="Cari dokumen..."
                          [(ngModel)]="documentSearchTerm" [ngModelOptions]="{standalone: true}">
                        <button class="btn btn-outline-secondary btn-lg" type="button">
                          <i class="ri-search-line"></i>
                        </button>
                      </div>
                    </div>
                    <table class="table table-hover table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th class="fs-5 py-3">Jenis Dokumen</th>
                          <th style="text-align: center; width: 150px" class="fs-5 py-3">Perlu</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let doc of getFilteredDocuments(); let i = index"
                          [ngClass]="{'table-success': doc.isChecked}">
                          <td class="fs-5 py-3">{{ doc.document_type }}</td>
                          <td style="text-align: center; vertical-align: middle">
                            <div class="form-check form-switch d-flex justify-content-center">
                              <input class="form-check-input form-check-input-lg" type="checkbox" role="switch"
                                [checked]="doc.isChecked" (change)="toggleCheckbox(doc, $event)">
                            </div>
                          </td>
                        </tr>
                        <tr *ngIf="getFilteredDocuments().length === 0">
                          <td colspan="2" class="text-center py-3 fs-5">Tidak ada dokumen yang sesuai dengan pencarian
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="alert alert-info mt-3">
                      <i class="ri-information-line me-2 fs-4"></i>
                      <span class="fs-5">
                        Untuk memasukkan <b>document number</b> pada checklist
                        perubahan, kalian bisa masuk ke halaman detail
                        <b>proposed changes</b> tersebut.
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-primary btn-lg" (click)="validateForm()">
          <i class="ri-checkbox-circle-line me-1"></i>
          Periksa Form
        </button>

        <div>
          <button type="button" class="btn btn-light btn-lg me-2" (click)="goBack()">
            <i class="ri-close-line me-1"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary btn-lg" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            <i class="ri-save-line me-1"></i> Submit Proposed Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>